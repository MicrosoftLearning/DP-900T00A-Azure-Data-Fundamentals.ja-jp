---
ms.openlocfilehash: 3e62289181d994a0e786bb53417f576ac1a3059b
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/05/2022
ms.locfileid: "138052491"
---
# <a name="azure-cosmos-db-client-library-for-javascripttypescript"></a>JavaScript/TypeScript 用 Azure Cosmos DB クライアント ライブラリ

[![最新の npm バッジ](https://img.shields.io/npm/v/%40azure%2Fcosmos/latest.svg)][npm]
[![ビルドの状態](https://dev.azure.com/azure-sdk/public/_apis/build/status/js/js%20-%20cosmosdb%20-%20ci?branchName=main)](https://dev.azure.com/azure-sdk/public/_build/latest?definitionId=850&branchName=main)

Azure Cosmos DB はグローバル分散型のマルチモデル データベース サービスであり、ドキュメント、キー値、ワイドカラム、グラフのデータベースをサポートします。 このパッケージは、JavaScript/Typescript アプリケーションで、**SQL API** データベースと、その中に含まれている JSON ドキュメントを操作するためのものです。

- Cosmos DB データベースを作成し、その設定を変更する
- JSON ドキュメントのコレクションを格納するためのコンテナーを作成および変更する
- コンテナー内の項目 (JSON ドキュメント) を作成、読み取り、更新、削除する
- SQL のような構文を使用してデータベース内のドキュメントに対してクエリを実行する

主要リンク:

- [パッケージ (npm)][npm]
- [API リファレンス ドキュメント](https://docs.microsoft.com/javascript/api/@azure/cosmos/?view=azure-node-lates)
- [製品ドキュメント][cosmos_docs]

## <a name="getting-started"></a>作業の開始

### <a name="prerequisites"></a>前提条件

#### <a name="azure-subscription-and-cosmos-db-sql-api-account"></a>Azure サブスクリプションと Cosmos DB SQL API アカウント

このパッケージを使用するには、[Azure サブスクリプション][azure_sub]と [Cosmos DB アカウント][cosmos_account] (SQL API) が必要です。

Cosmos DB SQL API アカウントが必要な場合は、Azure [Cloud Shell][cloud_shell_bash] を使用して、次の Azure CLI コマンドで作成できます。

```Bash
az cosmosdb create --resource-group <resource-group-name> --name <cosmos-database-account-name>
```

[Azure Portal](https://portal.azure.com/#create/microsoft.documentdb) でアカウントを作成することもできます

#### <a name="nodejs"></a>NodeJS

このパッケージは、[NodeJS](https://nodejs.org/en/) と共にプレインストールされる [npm][npm] 経由で配布されます。 Node v10 以降を使用している必要があります。

#### <a name="cors"></a>CORS

ブラウザー用に開発する必要がある場合は、Cosmos DB アカウントの[クロスオリジン リソース共有 (CORS)](https://docs.microsoft.com/azure/cosmos-db/how-to-configure-cross-origin-resource-sharing) ルールを設定する必要があります。 リンクされたドキュメントの指示に従って、Cosmos DB の新しい CORS ルールを作成します。

### <a name="install-this-package"></a>このパッケージをインストールする

```Bash
npm install @azure/cosmos
```

### <a name="get-account-credentials"></a>アカウントの資格情報を取得する

Cosmos DB **アカウント エンドポイント** と **キー** が必要です。 これらは [Azure Portal](https://portal.azure.com/#blade/hubsextension/browseresource/resourcetype/microsoft.documentdb%2fdatabaseaccounts) で見つけることができます。または、以下の [Azure CLI][azure_cli] スニペットを使用できます。 このスニペットは Bash シェル用にフォーマットされています。

```Bash
az cosmosdb show --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
az cosmosdb keys list --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
```

### <a name="create-an-instance-of-cosmosclient"></a>`CosmosClient` のインスタンスを作成する

Cosmos DB の操作は、[CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) クラスのインスタンスで始まります

```js
const { CosmosClient } = require("@azure/cosmos");

const endpoint = "https://your-account.documents.azure.com";
const key = "<database account masterkey>";
const client = new CosmosClient({ endpoint, key });

async function main() {
  // The rest of the README samples are designed to be pasted into this function body
}

main().catch((error) => {
  console.error(error);
});
```

わかりやすくするために、`key` と `endpoint` をコードに直接含めましたが、[dotenv](https://www.npmjs.com/package/dotenv) などのプロジェクトを使用してソース管理にないファイルからこれらを読み込んだり、環境変数から読み込んだりする必要がある可能性があります

運用環境では、キーなどのシークレットを [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) に格納する必要があります

## <a name="key-concepts"></a>主要な概念

[CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-lates) を初期化したら、Cosmos DB でプライマリ リソースの種類を操作できます。

- [データベース](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest): Cosmos DB アカウントに複数のデータベースを含めることができます。 データベースを作成する場合は、ドキュメントを操作するときに使用する API を指定します (SQL、MongoDB、Gremlin、Cassandra、または Azure Table)。 [データベース](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest) オブジェクトを使用して、そのコンテナーを管理します。

- [コンテナー](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest):コンテナーは、JSON ドキュメントのコレクションです。 [コンテナー](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest) オブジェクトでメソッドを使用して、コンテナー内の項目を作成 (挿入)、読み取り、更新、および削除します。

- [Item](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest):項目は、コンテナーに格納されている JSON ドキュメントです。 各項目には、コンテナー内の項目を一意に識別する値を持つ `id` キーを含める必要があります。 `id` を指定しない場合は、SDK によって自動生成されます。

これらのリソースの詳細については、「[Azure Cosmos データベース、コンテナー、および項目の操作][cosmos_resources]」を参照してください。

## <a name="examples"></a>例

次のセクションでは、以下を含む Cosmos DB の最も一般的なタスクのいくつかに対応したコード スニペットをいくつか紹介します。

- [データベースの作成](#create-a-database)
- [コンテナーの作成](#create-a-container)
- [項目を挿入する](#insert-items)
- [ドキュメントにクエリを実行する](#query-the-database)
- [項目を読み取る](#read-an-item)
- [項目の削除](#delete-an-data)

### <a name="create-a-database"></a>データベースを作成する

[CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) の認証後に、アカウント内の任意のリソースを操作できます。 以下のコード スニペットでは、SQL API データベースを作成します。

```js
const { database } = await client.databases.createIfNotExists({ id: "Test Database" });
console.log(database.id);
```

### <a name="create-a-container"></a>コンテナーを作成する

この例では、既定の設定でコンテナーを作成します

```js
const { container } = await database.containers.createIfNotExists({ id: "Test Database" });
console.log(container.id);
```

### <a name="insert-items"></a>項目を挿入する

コンテナーに項目を挿入するには、データを含むオブジェクトを [Items.upsert](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#upsert-t--requestoptions-) に渡します。 Cosmos DB サービスでは、各項目に `id` キーが必要です。 指定しない場合、SDK によって自動的に `id` が生成されます。

この例では、コンテナーに複数の項目を挿入します

```js
const cities = [
  { id: "1", name: "Olympia", state: "WA", isCapitol: true },
  { id: "2", name: "Redmond", state: "WA", isCapitol: false },
  { id: "3", name: "Chicago", state: "IL", isCapitol: false }
];
for (const city of cities) {
  container.items.create(city);
}
```

### <a name="read-an-item"></a>項目を読み取る

コンテナーから 1 つの項目を読み取るには、[Item.read](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#read-requestoptions-) を使用します。 これは、SQL を使用して `id` でクエリを実行するよりもコストの低い操作です。

```js
await container.item("1").read();
```

### <a name="delete-an-item"></a>項目を削除する

コンテナーから項目を削除するには、[Item.delete](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#delete-requestoptions-) を使用します。

```js
// Delete the first item returned by the query above
await container.item("1").delete();
```

### <a name="query-the-database"></a>データベースのクエリを実行する

Cosmos DB SQL API データベースでは、次の SQL のような構文を使用する [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-) でのコンテナー内の項目に対するクエリの実行がサポートされています。

```js
const { resources } = await container.items
  .query("SELECT * from c WHERE c.isCapitol = true")
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

パラメーターとその値を含むオブジェクトを [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-) に渡して、パラメーター化されたクエリを実行します。

```js
const { resources } = await container.items
  .query({
    query: "SELECT * from c WHERE c.isCapitol = @isCapitol",
    parameters: [{ name: "@isCapitol", value: true }]
  })
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

SQL API を使用する Cosmos DB データベースに対するクエリの実行について詳しくは、[SQL クエリを使用する Azure Cosmos DB データに対するクエリの実行][cosmos_sql_queries]に関するページを参照してください。

## <a name="troubleshooting"></a>トラブルシューティング

### <a name="general"></a>全般

Cosmos DB を操作する場合、このサービスによって返されるエラーは、REST API 要求に対して返される同じ HTTP 状態コードに対応しています。

[Azure Cosmos DB の HTTP 状態コード][cosmos_http_status_codes]

#### <a name="conflicts"></a>競合

たとえば、Cosmos DB データベースで既に使用されている `id` を使って項目を作成しようとすると、競合を示す `409` エラーが返されます。 次のスニペットでは、例外をキャッチし、エラーに関する追加情報を表示することで、エラーが適切に処理されます。

```js
try {
  await containers.items.create({ id: "existing-item-id" });
} catch (error) {
  if (error.code === 409) {
    console.log("There was a conflict with an existing item");
  }
}
```

### <a name="transpiling"></a>トランスパイル

Azure SDK は、ES5 JavaScript 構文と [LTS バージョンの Node.js](https://nodejs.org/about/releases/) をサポートするように設計されています。 Internet Explorer や Node 6 などの以前の JavaScript ランタイムのサポートが必要な場合は、ビルド プロセスの一環として SDK コードをトランスパイルする必要があります。

### <a name="handle-transient-errors-with-retries"></a>再試行による一時的なエラーを処理する

Computer DB の操作中に、このサービスによって適用された[レート制限][cosmos_request_units]によって一時的な障害が発生したり、ネットワークの停止など、他の一時的な問題が発生したりする可能性があります。 これらの種類の障害の処理については、クラウド設計パターン ガイドの「[再試行パターン][azure_pattern_retry]」および「[サーキット ブレーカー パターン][azure_pattern_circuit_breaker]」を参照してください。

## <a name="next-steps"></a>次のステップ

### <a name="more-sample-code"></a>その他のサンプル コード

[いくつかのサンプル][cosmos_samples]は、SDK の GitHub リポジトリで入手できます。 これらのサンプルでは、Computer DB の操作中によく発生する追加のシナリオのコード例が示されています。

- データベース操作
- コンテナー操作
- 項目操作
- インデックス作成の構成
- コンテナー変更フィードの読み取り
- ストアド プロシージャ
- データベースまたはコンテナーのスループット設定の変更
- 複数リージョンの書き込み操作

### <a name="additional-documentation"></a>その他のドキュメント

Cosmos DB サービスに関するさらに詳細なドキュメントについては、docs.microsoft.com にある [Azure Cosmos DB のドキュメント][cosmos_docs]を参照してください。

## <a name="useful-links"></a>便利なリンク

- [Azure Cosmos DB へようこそ](https://docs.microsoft.com/azure/cosmos-db/community)
- [クイック スタート](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-get-started)
- [チュートリアル](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-application)
- [サンプル](https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples)
- [Azure Cosmos DB サービスのリソース モデルの概要](https://docs.microsoft.com/azure/cosmos-db/sql-api-resources)
- [Azure Cosmos DB サービスの SQL API の概要](https://docs.microsoft.com/azure/cosmos-db/sql-api-sql-query)
- [パーティション分割](https://docs.microsoft.com/azure/cosmos-db/sql-api-partition-data)
- [API ドキュメント](https://docs.microsoft.com/javascript/api/%40azure/cosmos/?view=azure-node-latest)

## <a name="contributing"></a>共同作成

このライブラリに投稿する場合、コードをビルドしてテストする方法の詳細については、[投稿ガイド](https://github.com/Azure/azure-sdk-for-js/blob/main/CONTRIBUTING.md)を参照してください。

![インプレッション数](https://azure-sdk-impressions.azurewebsites.net/api/impressions/azure-sdk-for-js%2Fsdk%2Fcosmosdb%2Fcosmos%2FREADME.png)

<!-- LINKS -->

[azure_cli]: https://docs.microsoft.com/cli/azure
[azure_pattern_circuit_breaker]: https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker
[azure_pattern_retry]: https://docs.microsoft.com/azure/architecture/patterns/retry
[azure_portal]: https://portal.azure.com
[azure_sub]: https://azure.microsoft.com/free/
[cloud_shell]: https://docs.microsoft.com/azure/cloud-shell/overview
[cloud_shell_bash]: https://shell.azure.com/bash
[cosmos_account_create]: https://docs.microsoft.com/azure/cosmos-db/how-to-manage-database-account
[cosmos_account]: https://docs.microsoft.com/azure/cosmos-db/account-overview
[cosmos_container]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-containers
[cosmos_database]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-databases
[cosmos_docs]: https://docs.microsoft.com/azure/cosmos-db/
[cosmos_http_status_codes]: https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb
[cosmos_item]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-items
[cosmos_request_units]: https://docs.microsoft.com/azure/cosmos-db/request-units
[cosmos_resources]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items
[cosmos_samples]: https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples
[cosmos_sql_queries]: https://docs.microsoft.com/azure/cosmos-db/how-to-sql-query
[cosmos_ttl]: https://docs.microsoft.com/azure/cosmos-db/time-to-live
[npm]: https://www.npmjs.com/package/@azure/cosmos
