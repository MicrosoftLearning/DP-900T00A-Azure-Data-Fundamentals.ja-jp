---
ms.openlocfilehash: 03ad292b1fceecb8974f1d8753cb47723344dbf3
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/05/2022
ms.locfileid: "138052539"
---
# <a name="stoppable"></a>Stoppable

[![ビルドの状況](https://travis-ci.org/hunterloftis/stoppable.svg?branch=master)](https://travis-ci.org/hunterloftis/stoppable)

> [既定の動作として想定されていた ](https://github.com/nodejs/node/issues/2642)Node の `server.close()`。

## <a name="summary"></a>まとめ

```js
const server = stoppable(http.createServer(handler))
server.stop()
```

Stoppable を使用すると、新しい接続の受け入れが停止されることに加え、処理中の要求を強制終了することなく、既存のアイドル状態の接続 (keep-alives を含む) が閉じられます。

## <a name="requirements"></a>要件

- Node.js v6+

Node.js v4.x は、*非公式* にサポートされています。

## <a name="installation"></a>インストール

```bash
yarn add stoppable
```

(または、npm を使用)

## <a name="usage"></a>使用

**constructor**

```js
stoppable(server, grace)
```

`stop` メソッドで、サーバー インスタンスを装飾します。
サーバー インスタンスを返します。そのため、チェーンしたり、スタンドアロン ステートメントとして実行したりすることができます。

- server: 任意の HTTP または HTTPS サーバー インスタンス
- grace: 強制終了接続の前に待機するミリ秒

`grace` の既定値は Infinity です (強制終了しないでください)。
すべてのソケットをただちに強制終了する必要がある場合は、grace を 0 にします。

**stop()**

```js
server.stop(callback)
```

サーバーを閉じます。

- callback: "close" イベントを自動登録するために、既存の `server.close` 関数に渡されます。
最初の引数はエラーであり、2 つ目の引数は正常に停止したかどうかを示すブール値です。

## <a name="design-decisions"></a>設計上の決定

- 一般的に、モンキー パッチは役に立ちませんが、このような場合の API としては最適です。 これを "装飾" と呼ぶことにしましょう。
- `stop` に対して `grace` を指定することはできますが、既存の `server.close` API の方が適しています。
- ソケットを破棄するだけではなく、最初に `FIN` パケットを送信するよう、クライアントをていねいに処理する必要があります。
- この問題を解決するには、すべての接続、および要求や応答についてブックキーピングを行うことが必要です。
これらの "hot" コード パスについては、最小限の作業を行い、実際の `stop` メソッドに対しては、最大限の遅延を発生させます。

## <a name="performance"></a>パフォーマンス

接続、切断、要求、応答に対してブックキーピングを行わなければ、この機能を実現する方法はありません。
ただし、Stoppable は、ホット コード パスで最小限の作業を行い、最適なデータ構造を使用することを目的としています。

私は、実際のパフォーマンス ベンチマークを確認したいと考えています。ライブラリに含まれる単純なループバック artillery ベンチマークは、Stoppable サーバーを使用する場合はオーバーヘッドがほとんど発生しないことを示しています。

### <a name="without-stoppable"></a>Stoppable なし

```plain
  Scenarios launched:  10000
  Scenarios completed: 10000
  Requests completed:  10000
  RPS sent: 939.85
  Request latency:
    min: 0.5
    max: 51.3
    median: 2.1
    p95: 3.7
    p99: 15.3
  Scenario duration:
    min: 1
    max: 60.7
    median: 3.6
    p95: 7.6
    p99: 19
  Scenario counts:
    0: 10000 (100%)
  Codes:
    200: 10000
```

### <a name="with-stoppable"></a>Stoppable あり

```plain
  Scenarios launched:  10000
  Scenarios completed: 10000
  Requests completed:  10000
  RPS sent: 940.73
  Request latency:
    min: 0.5
    max: 43.4
    median: 2.1
    p95: 3.8
    p99: 15.5
  Scenario duration:
    min: 1.1
    max: 57
    median: 3.7
    p95: 8
    p99: 19.4
  Scenario counts:
    0: 10000 (100%)
  Codes:
    200: 10000
```

## <a name="license"></a>ライセンス

MIT